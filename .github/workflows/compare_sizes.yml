name: Compare contract sizes with master
on:
  issue_comment:
    types:
      - created
jobs:
  generate_report:
    runs-on: ubuntu-latest
    if: ${{ (github.event.issue.pull_request) && (github.event.comment.body == '/compare') }}
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Checkout Pull Request
        run: gh pr checkout ${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Install cargo-near CLI (dependency for docker builds in generate report)
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/near/cargo-near/releases/download/cargo-near-v0.17.0/cargo-near-installer.sh | sh
      - name: Generate report
        id: generate
        run: |
          pip install GitPython
          # Capture output to temp file first to avoid corrupting GITHUB_ENV if script fails
          if ci/compare_sizes/compare_sizes.py > /tmp/report.txt 2> /tmp/report_err.txt; then
            {
              echo 'REPORT<<EOF'
              cat /tmp/report.txt
              echo 'EOF'
            } >> "$GITHUB_ENV"
          else
            # Capture error output for the failure notification
            {
              echo 'ERROR_OUTPUT<<EOF'
              tail -50 /tmp/report_err.txt
              echo 'EOF'
            } >> "$GITHUB_ENV"
            exit 1
          fi
      - name: Submit report
        if: ${{ success() }}
        uses: actions/github-script@v4
        with:
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.REPORT,
            });
      - name: Notify about failure
        if: ${{ failure() && steps.generate.outcome == 'failure' }}
        uses: actions/github-script@v4
        with:
          script: |
            const errorOutput = process.env.ERROR_OUTPUT || 'No error output captured';
            const body = `Failed to generate size comparison report!

<details>
<summary>Error details</summary>

\`\`\`
${errorOutput}
\`\`\`

</details>

See the [failed CI job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.`;
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body,
            });
