name: Compare Contract Sizes
on:
  pull_request:
    paths:
      - 'near-sdk/**'
      - 'near-sdk-macros/**'
      - 'near-contract-standards/**'
      - 'examples/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

env:
  # Threshold percentage for reporting size changes (changes below this are considered insignificant)
  SIZE_THRESHOLD: 1

jobs:
  compare-sizes:
    runs-on: warp-ubuntu-latest-x64-4x
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-near CLI
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/near/cargo-near/releases/download/cargo-near-v0.19.1/cargo-near-installer.sh | sh

      - name: Restore baseline sizes from cache
        id: restore-baseline
        uses: actions/cache/restore@v4
        with:
          path: sizes-baseline.json
          key: contract-sizes-baseline-master

      - name: Handle missing baseline
        if: steps.restore-baseline.outputs.cache-hit != 'true'
        run: |
          echo "::warning::No baseline sizes found. This is expected for the first run."
          echo "Creating empty baseline..."
          echo '{}' > sizes-baseline.json

      - name: Build examples and collect sizes
        run: python3 ci/compare_sizes.py build --output sizes-current.json

      - name: Compare sizes and generate report
        id: compare
        run: |
          python3 ci/compare_sizes.py compare sizes-baseline.json sizes-current.json \
            --threshold $SIZE_THRESHOLD \
            --output size-report.md

          # Extract markers from report for CI decisions
          HAS_CHANGES=$(grep -oP '(?<=CONTRACT_SIZES_HAS_CHANGES:)\w+' size-report.md || echo "false")
          EXIT_CODE=$(grep -oP '(?<=CONTRACT_SIZES_EXIT_CODE:)\d+' size-report.md || echo "0")

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          echo "## Size Comparison Report"
          cat size-report.md

      - name: Prepend marker to report
        if: steps.compare.outputs.has_changes == 'true'
        run: |
          # Add hidden marker for comment identification
          echo '<!-- contract-size-report -->' | cat - size-report.md > temp && mv temp size-report.md

      - name: Find existing comment
        if: steps.compare.outputs.has_changes == 'true'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- contract-size-report -->'

      - name: Create or update comment
        if: steps.compare.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: size-report.md

      # Optional: fail the job if sizes increased significantly
      # Uncomment the following to enforce size limits
      # - name: Fail if sizes increased
      #   if: steps.compare.outputs.exit_code == '1'
      #   run: |
      #     echo "::error::Contract sizes increased beyond threshold!"
      #     exit 1
