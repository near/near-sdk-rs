name: Test Small Examples
on:
  push:
    branches:
      - master
  pull_request:
env:
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: short
  NEAR_RPC_TIMEOUT_SECS: 100

jobs:
  test:
    runs-on: ${{ matrix.platform.os }}
    name: "${{ matrix.example }} - ${{ matrix.platform.name }}"
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: warp-ubuntu-latest-x64-4x
            name: linux
          - os: warp-macos-latest-arm64-6x
            name: macos
        toolchain: ["1.86"]
        example:
          [
            lockable-fungible-token,
            status-message,
            mission-control,
            test-contract,
          ]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.toolchain }} with wasm32 target
        run: |
          rustup toolchain install ${{ matrix.toolchain }} --profile minimal --target wasm32-unknown-unknown
          rustup override set ${{ matrix.toolchain }}

      - name: Install cargo-near CLI
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/near/cargo-near/releases/download/cargo-near-v0.17.0/cargo-near-installer.sh | sh

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - uses: Swatinem/rust-cache@v2
        with:
          cache-provider: warpbuild
          workspaces: "./examples/${{ matrix.example }} -> target"
          shared-key: "${{ matrix.platform.name }}-${{ matrix.toolchain }}-${{ matrix.example }}"
          cache-all-crates: true

      - name: Run tests with nextest
        run: cargo +${{ matrix.toolchain }} nextest run --manifest-path=./examples/${{ matrix.example }}/Cargo.toml --workspace --config-file .config/nextest.toml --profile ci

      # Run doctests separately (nextest doesn't support doctests yet)
      - name: Run doctests
        run: cargo +${{ matrix.toolchain }} test --manifest-path=./examples/${{ matrix.example }}/Cargo.toml --workspace --doc
