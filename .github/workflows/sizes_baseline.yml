name: Contract Sizes Baseline
on:
  push:
    branches:
      - master
    paths:
      - 'near-sdk/**'
      - 'near-sdk-macros/**'
      - 'near-contract-standards/**'
      - 'examples/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'ci/compare_sizes.py'
  workflow_dispatch: # Allow manual trigger for initial baseline

jobs:
  # Build examples in parallel
  build-example:
    runs-on: warp-ubuntu-latest-x64-4x
    strategy:
      fail-fast: false
      matrix:
        example:
          # Standalone examples
          - adder
          - callback-results
          - lockable-fungible-token
          - mission-control
          - mpc-contract
          - status-message
          - test-contract
          - versioned
          # Workspace examples (build all members at once)
          - cross-contract-calls
          - factory-contract
          # Note: factory-contract-global is excluded - it lacks [package.metadata.near.reproducible_build]
          - fungible-token
          - non-fungible-token
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-near CLI
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/near/cargo-near/releases/download/cargo-near-v0.19.1/cargo-near-installer.sh | sh

      - name: Build example
        run: |
          cd examples/${{ matrix.example }}
          # For workspaces, build all members
          if [[ -f "Cargo.toml" ]] && grep -q '\[workspace\]' "Cargo.toml"; then
            for member in $(cargo metadata --no-deps --format-version 1 2>/dev/null | jq -r '.packages[].manifest_path' | xargs -I{} dirname {} | sort -u); do
              echo "Building workspace member: $member"
              (cd "$member" && cargo near build reproducible-wasm --no-locked) || echo "Warning: $member failed"
            done
          else
            cargo near build reproducible-wasm --no-locked
          fi

      - name: Collect size
        run: |
          mkdir -p sizes
          find examples/${{ matrix.example }}/target/near -name "*.wasm" -type f 2>/dev/null | while read wasm; do
            name=$(basename "$wasm")
            size=$(stat --format='%s' "$wasm")
            echo "Found: $name ($size bytes)"
            echo "{\"$name\": $size}" > "sizes/${name%.wasm}.json"
          done
          echo "Collected sizes:"
          ls -la sizes/ 2>/dev/null || echo "No sizes collected"

      - name: Upload size artifact
        uses: actions/upload-artifact@v4
        with:
          name: size-${{ strategy.job-index }}
          path: sizes/
          retention-days: 1

  # Combine and cache baseline
  save-baseline:
    needs: build-example
    runs-on: warp-ubuntu-latest-x64-4x
    steps:
      - uses: actions/checkout@v4

      - name: Download all size artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-sizes
          pattern: size-*

      - name: Combine sizes into JSON
        run: |
          echo '{}' > sizes-baseline.json
          find all-sizes -name "*.json" -type f | while read f; do
            jq -s '.[0] * .[1]' sizes-baseline.json "$f" > tmp.json && mv tmp.json sizes-baseline.json
          done
          echo "Baseline sizes:"
          cat sizes-baseline.json

      - name: Save baseline to cache
        uses: actions/cache/save@v4
        with:
          path: sizes-baseline.json
          key: contract-sizes-baseline-${{ github.sha }}

      - name: Save baseline with stable key
        uses: actions/cache/save@v4
        with:
          path: sizes-baseline.json
          key: contract-sizes-baseline-master

      - name: Cleanup artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: size-*
          failOnError: false
