name: Contract Sizes Baseline
on:
  push:
    branches:
      - master
    paths:
      - 'near-sdk/**'
      - 'near-sdk-macros/**'
      - 'near-contract-standards/**'
      - 'examples/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch: # Allow manual trigger for initial baseline

jobs:
  # Build examples in parallel
  build-example:
    runs-on: warp-ubuntu-latest-x64-4x
    strategy:
      fail-fast: false
      matrix:
        example:
          - adder
          - callback-results
          - cross-contract-calls/high-level
          - cross-contract-calls/low-level
          - factory-contract/high-level
          - factory-contract/low-level
          - fungible-token/ft
          - fungible-token/test-contract-defi
          - lockable-fungible-token
          - mission-control
          - mpc-contract
          - non-fungible-token/nft
          - non-fungible-token/test-approval-receiver
          - non-fungible-token/test-token-receiver
          - status-message
          - test-contract
          - versioned
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-near CLI
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/near/cargo-near/releases/download/cargo-near-v0.19.1/cargo-near-installer.sh | sh

      - name: Build example
        run: |
          cd examples/${{ matrix.example }}
          cargo near build reproducible-wasm --no-locked

      - name: Collect size
        run: |
          mkdir -p sizes
          find examples/${{ matrix.example }}/target/near -name "*.wasm" -type f | while read wasm; do
            name=$(basename "$wasm")
            size=$(stat --format='%s' "$wasm")
            echo "{\"$name\": $size}" > "sizes/${name%.wasm}.json"
          done

      - name: Upload size artifact
        uses: actions/upload-artifact@v4
        with:
          name: size-${{ strategy.job-index }}
          path: sizes/
          retention-days: 1

  # Combine and cache baseline
  save-baseline:
    needs: build-example
    runs-on: warp-ubuntu-latest-x64-4x
    steps:
      - uses: actions/checkout@v4

      - name: Download all size artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-sizes
          pattern: size-*

      - name: Combine sizes into JSON
        run: |
          echo '{}' > sizes-baseline.json
          find all-sizes -name "*.json" -type f | while read f; do
            jq -s '.[0] * .[1]' sizes-baseline.json "$f" > tmp.json && mv tmp.json sizes-baseline.json
          done
          echo "Baseline sizes:"
          cat sizes-baseline.json

      - name: Save baseline to cache
        uses: actions/cache/save@v4
        with:
          path: sizes-baseline.json
          key: contract-sizes-baseline-${{ github.sha }}

      - name: Save baseline with stable key
        uses: actions/cache/save@v4
        with:
          path: sizes-baseline.json
          key: contract-sizes-baseline-master
